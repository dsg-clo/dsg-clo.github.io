<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kabupaten Detail Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .tab-active {
        background-color: #1e40af !important;
        color: white !important;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
      }
      .bg-card-blue {
        background-color: #f0f7ff;
      }
      .bg-card-green {
        background-color: #f0fff4;
      }
      .badge-white {
        background: white;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 10px;
        color: #64748b;
        border: 1px solid #e2e8f0;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.4s ease-out forwards;
      }

      .uko-card-active {
        border-color: #1e40af !important;
        background-color: #eff6ff !important;
        box-shadow: 0 0 0 2px #1e40af inset !important;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <header
      class="bg-white border-b px-8 py-4 flex justify-between items-center shadow-sm sticky top-0 z-20"
    >
      <div>
        <h1 class="text-2xl font-black text-blue-900" id="pageTitle">
          Loading...
        </h1>
        <p
          class="text-gray-400 text-xs uppercase tracking-widest font-bold mt-1"
          id="pageSubtitle"
        >
          Laporan Profil Wilayah
        </p>
      </div>
      <a
        href="profilekab.html"
        class="flex items-center gap-2 text-blue-600 font-bold hover:underline transition-all"
      >
        <span class="material-icons text-sm">arrow_back</span> Back to Filter
      </a>
    </header>

    <nav
      class="flex bg-white px-8 border-b sticky top-[73px] z-10 overflow-x-auto no-scrollbar gap-1 pt-2"
    >
      <button
        class="tab-btn px-6 py-4 whitespace-nowrap text-gray-500 font-bold"
        data-target="tab-info"
      >
        Informasi & Demografi
      </button>
      <button
        class="tab-btn px-6 py-4 whitespace-nowrap text-gray-500 font-bold"
        data-target="tab-echannel"
      >
        E-Channel
      </button>
      <button
        class="tab-btn px-6 py-4 whitespace-nowrap text-gray-500 font-bold"
        data-target="tab-perf"
      >
        Performance
      </button>
      <button
        class="tab-btn px-6 py-4 whitespace-nowrap text-gray-500 font-bold"
        data-target="tab-hc"
      >
        Human Capital
      </button>
      <button
        class="tab-btn px-6 py-4 whitespace-nowrap text-gray-500 font-bold"
        data-target="tab-customer"
      >
        Customer
      </button>
    </nav>

    <main class="p-8 max-w-7xl mx-auto">
      <section id="tab-info" class="tab-content hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div
            class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"
          >
            <h3
              class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-800"
            >
              <span class="material-icons">info</span> Detail Administrasi
            </h3>
            <table class="w-full text-sm leading-10">
              <tbody id="info-table" class="text-gray-700"></tbody>
            </table>
          </div>
          <div
            class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"
          >
            <h3
              class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-800"
            >
              <span class="material-icons">analytics</span> Pesaing & Populasi
            </h3>
            <div class="grid grid-cols-2 gap-4" id="demografi-grid"></div>
          </div>
        </div>

        <div
          class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-6"
        >
          <div
            class="flex flex-col md:flex-row md:items-center justify-between gap-4"
          >
            <h3 class="text-lg font-bold flex items-center gap-2 text-blue-800">
              <span class="material-icons">business</span> Sebaran UKO Supervisi
            </h3>
            <div class="flex items-center gap-2">
              <button
                onclick="resetUkoSelection()"
                class="text-[10px] bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded font-bold text-gray-500 uppercase tracking-tighter"
              >
                Reset Selection
              </button>
            </div>
          </div>
          <div
            class="grid grid-cols-2 md:grid-cols-5 gap-4"
            id="uko-grid"
          ></div>
          <div class="pt-6 border-t border-gray-100">
            <div
              class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4"
            >
              <p
                class="text-[10px] font-black text-gray-400 uppercase tracking-widest italic"
              >
                Rincian:
                <span id="current-uko-type" class="text-blue-600"
                  >Semua Tipe</span
                >
              </p>
              <div class="relative w-full md:w-64">
                <span
                  class="material-icons absolute left-3 top-2 text-gray-400 text-sm"
                  >search</span
                >
                <input
                  type="text"
                  id="uko-search"
                  placeholder="Cari unit atau alamat..."
                  class="w-full pl-9 pr-4 py-2 border rounded-lg text-xs focus:ring-2 focus:ring-blue-500 outline-none"
                />
              </div>
            </div>
            <div
              class="overflow-hidden rounded-xl border border-gray-100 shadow-sm"
            >
              <div class="overflow-x-auto no-scrollbar">
                <table class="w-full text-left border-collapse min-w-[600px]">
                  <thead
                    class="bg-gray-50 text-[10px] font-black text-gray-500 uppercase border-b"
                  >
                    <tr>
                      <th class="px-6 py-4">Nama Unit Kerja</th>
                      <th class="px-6 py-4">Tipe</th>
                      <th class="px-6 py-4">Status</th>
                      <th class="px-6 py-4">Alamat / Lokasi</th>
                    </tr>
                  </thead>
                  <tbody
                    id="uko-list-table"
                    class="divide-y text-xs text-gray-700 bg-white"
                  ></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-echannel" class="tab-content hidden space-y-6">
        <div id="premises-container"></div>
        <div
          id="echannel-grid"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4"
        ></div>
      </section>

      <section id="tab-perf" class="tab-content hidden space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            class="bg-white p-8 rounded-2xl shadow-sm border-t-4 border-blue-600 text-center"
          >
            <p class="text-gray-400 text-xs font-black uppercase">KPI Score</p>
            <h2 id="perf-kpi" class="text-5xl font-black text-blue-900 mt-2">
              -
            </h2>
          </div>
          <div
            class="bg-white p-8 rounded-2xl shadow-sm border-t-4 border-green-500 text-center"
          >
            <p class="text-gray-400 text-xs font-black uppercase">
              Market Share DPK
            </p>
            <h2 id="perf-dpk" class="text-5xl font-black text-green-600 mt-2">
              -
            </h2>
          </div>
          <div
            class="bg-white p-8 rounded-2xl shadow-sm border-t-4 border-red-500 text-center"
          >
            <p class="text-gray-400 text-xs font-black uppercase">NPL Ratio</p>
            <h2 id="perf-npl" class="text-5xl font-black text-red-600 mt-2">
              -
            </h2>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div
            class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm"
          >
            <h3
              class="text-xs font-black text-gray-400 uppercase mb-4 text-center"
            >
              DPK Trend
            </h3>
            <div class="h-48"><canvas id="mainDpkChart"></canvas></div>
          </div>
          <div
            class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm"
          >
            <h3
              class="text-xs font-black text-gray-400 uppercase mb-4 text-center"
            >
              Loan Growth Trend
            </h3>
            <div class="h-48"><canvas id="loanChart"></canvas></div>
          </div>
        </div>
      </section>

      <section id="tab-hc" class="tab-content hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div
            class="bg-card-green p-6 rounded-xl shadow-sm border border-green-100 text-center"
          >
            <h4 class="text-gray-700 font-bold mb-4">Jumlah Formasi</h4>
            <p id="total-formasi" class="text-4xl font-black text-gray-800">
              0
            </p>
          </div>
          <div
            class="bg-card-green p-6 rounded-xl shadow-sm border border-green-100 text-center"
          >
            <h4 class="text-gray-700 font-bold mb-4">Jumlah Pemenuhan</h4>
            <p id="total-pemenuhan" class="text-4xl font-black text-gray-800">
              0
            </p>
          </div>
          <div
            class="bg-card-green p-6 rounded-xl shadow-sm border border-green-100 text-center"
          >
            <h4 class="text-gray-700 font-bold mb-4">Gap</h4>
            <p id="total-gap" class="text-4xl font-black text-red-600">0</p>
          </div>
        </div>
        <div
          class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
        >
          <table class="w-full text-left border-collapse">
            <thead
              class="bg-gray-50 text-gray-400 text-[10px] font-black uppercase border-b"
            >
              <tr>
                <th class="px-8 py-4">Jenis Formasi</th>
                <th class="px-8 py-4 text-center">Formasi</th>
                <th class="px-8 py-4 text-center">Pemenuhan</th>
                <th class="px-8 py-4 text-center">Gap</th>
              </tr>
            </thead>
            <tbody id="hc-table-body" class="divide-y text-sm"></tbody>
          </table>
        </div>
      </section>

      <section id="tab-customer" class="tab-content hidden space-y-8">
        <div
          class="bg-gradient-to-br from-blue-950 via-blue-900 to-indigo-900 p-10 rounded-[2.5rem] text-white shadow-xl flex justify-between items-center relative overflow-hidden"
        >
          <div class="relative z-10">
            <p
              class="text-blue-300 text-xs font-black uppercase tracking-[0.3em] mb-2"
            >
              Total CIF Wilayah
            </p>
            <h2
              id="cust-total"
              class="text-7xl font-black tracking-tighter italic"
            >
              0
            </h2>
          </div>
          <span
            class="material-icons text-[150px] absolute right-[-10px] opacity-10 rotate-12"
            >groups</span
          >
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <div
            id="cust-gen-container"
            class="lg:col-span-8 grid grid-cols-1 sm:grid-cols-2 gap-4"
          ></div>
          <div
            class="lg:col-span-4 bg-white p-8 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col items-center justify-center"
          >
            <h3
              class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-6"
            >
              Demographic Share
            </h3>
            <div class="w-full max-w-[220px] aspect-square">
              <canvas id="customerPieChart"></canvas>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script src="branchdetail.js"></script>
    <script>
      let charts = {};
      let fullRawUko = {};
      let selectedUkoTypes = new Set();

      function initLineChart(id, labels, data, color) {
        const ctx = document.getElementById(id).getContext("2d");
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                borderColor: color,
                backgroundColor: color + "15",
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
          },
        });
      }

      function initPieChart(id, labels, data) {
        const ctx = document.getElementById(id).getContext("2d");
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: ["#1e3a8a", "#2563eb", "#60a5fa", "#94a3b8"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
                labels: { boxWidth: 12, font: { weight: "bold", size: 10 } },
              },
            },
            cutout: "75%",
          },
        });
      }

      function updateUkoTable() {
        const tableBody = document.getElementById("uko-list-table");
        const typeLabel = document.getElementById("current-uko-type");
        const keyword = document
          .getElementById("uko-search")
          .value.toLowerCase();
        tableBody.innerHTML = "";
        let combined = [];
        const activeTypes =
          selectedUkoTypes.size > 0
            ? Array.from(selectedUkoTypes)
            : Object.keys(fullRawUko);
        typeLabel.innerText =
          selectedUkoTypes.size > 0
            ? Array.from(selectedUkoTypes)
                .join(", ")
                .replace(/_/g, " ")
                .toUpperCase()
            : "SEMUA TIPE";

        activeTypes.forEach((type) => {
          (fullRawUko[type].list || []).forEach((unit) => {
            if (
              unit.nama.toLowerCase().includes(keyword) ||
              (unit.alamat && unit.alamat.toLowerCase().includes(keyword))
            ) {
              combined.push({ ...unit, label: type.replace(/_/g, " ") });
            }
          });
        });

        if (combined.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-10 text-center text-gray-400 uppercase text-[10px] font-bold">Data tidak ditemukan</td></tr>`;
          return;
        }
        combined.forEach((unit) => {
          tableBody.innerHTML += `
            <tr class="hover:bg-blue-50/50 transition-colors animate-fade-in">
              <td class="px-6 py-4 font-bold text-blue-900">${unit.nama || "-"}</td>
              <td class="px-6 py-4"><span class="bg-gray-100 px-2 py-1 rounded text-[9px] font-black uppercase text-gray-500">${unit.label}</span></td>
              <td class="px-6 py-4"><span class="flex items-center gap-1 text-green-600 font-bold"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Aktif</span></td>
              <td class="px-6 py-4 text-gray-400 italic font-medium">${unit.alamat || "Alamat tidak tersedia"}</td>
            </tr>`;
        });
      }

      function resetUkoSelection() {
        selectedUkoTypes.clear();
        document
          .querySelectorAll(".uko-filter-card")
          .forEach((c) => c.classList.remove("uko-card-active"));
        updateUkoTable();
      }

      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code") || "1";
        const data = KOKAB_DETAIL_DATA[code];
        if (!data) return;

        const id = data.identkab || data.identreg;
        document.getElementById("pageTitle").innerText = (
          id.nama_kab ||
          id.nama_unit_kerja ||
          "DETAIL"
        ).toUpperCase();
        document.getElementById("pageSubtitle").innerText =
          `Provinsi ${id.provinsi} | ${id.area || id.region_supervisi}`;

        const infoTable = document.getElementById("info-table");
        const infoItems = {
          "Nama Kota/Kab": id.nama_kab || id.nama_unit_kerja,
          Klasifikasi: id.klasifikasi_wilayah,
          Area: id.area || "-",
          Provinsi: id.provinsi,
          Region: id.region_supervisi || id.region,
        };
        Object.entries(infoItems).forEach(([k, v]) => {
          infoTable.innerHTML += `<tr><td class="font-bold text-gray-400 w-40 uppercase text-[10px]">${k}</td><td class="text-gray-800 font-semibold">: ${v || "-"}</td></tr>`;
        });

        const demoGrid = document.getElementById("demografi-grid");
        if (data.demografi) {
          Object.entries(data.demografi).forEach(([k, v]) => {
            demoGrid.innerHTML += `<div class="bg-gray-50 p-4 rounded-xl border border-gray-100 text-center"><p class="text-[10px] font-bold text-gray-400 uppercase">${k.replace(/_/g, " ")}</p><p class="text-xl font-black text-blue-900 mt-1">${v}</p></div>`;
          });
        }

        fullRawUko = data.uko_supervisi || {};
        const ukoGrid = document.getElementById("uko-grid");
        Object.entries(fullRawUko).forEach(([k, v]) => {
          const card = document.createElement("div");
          card.className =
            "cursor-pointer bg-white p-4 rounded-xl border border-gray-100 text-center shadow-sm hover:border-blue-500 hover:bg-blue-50 transition-all group uko-filter-card";
          card.innerHTML = `<p class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter mb-1 group-hover:text-blue-500">${k.replace(/_/g, " ")}</p><p class="text-2xl font-black text-blue-600">${v.jumlah}</p>`;
          card.onclick = () => {
            if (selectedUkoTypes.has(k)) {
              selectedUkoTypes.delete(k);
              card.classList.remove("uko-card-active");
            } else {
              selectedUkoTypes.add(k);
              card.classList.add("uko-card-active");
            }
            updateUkoTable();
          };
          ukoGrid.appendChild(card);
        });
        updateUkoTable();
        document.getElementById("uko-search").oninput = updateUkoTable;

        // E-CHANNEL (KEMBALI KE STRUKTUR BRANCH DETAIL)
        document.getElementById("premises-container").innerHTML =
          `<div class="bg-card-green p-5 rounded-2xl border border-green-100 w-full sm:w-60"><div class="flex justify-between items-start mb-4"><span class="text-sm font-black text-green-800 uppercase">Premises</span><span class="badge-white">Mei</span></div><h2 class="text-4xl font-black text-gray-800">${data.performance_potensi.kpi.score}%</h2><p class="text-red-500 text-xs font-bold">↓ ${Math.abs(data.performance_potensi.kpi.trend)}%</p></div>`;

        const ecGrid = document.getElementById("echannel-grid");
        const channels = [
          { id: "atm", l: "ATM" },
          { id: "crm", l: "CRM" },
          { id: "edc", l: "EDC" },
          { id: "qris", l: "TERAS" },
          { id: "brilink", l: "Agen Brilink" },
        ];
        channels.forEach((ch) => {
          const item = data[ch.id];
          if (!item) return;
          ecGrid.innerHTML += `
            <div class="bg-card-blue p-5 rounded-2xl border border-blue-50 transition-all hover:shadow-md">
                <div class="flex justify-between items-center mb-6"><span class="font-black text-blue-900 text-sm uppercase">${ch.l}</span><span class="badge-white">Mei</span></div>
                <div class="text-[11px] space-y-2 mb-6">
                    <div class="flex justify-between text-gray-800 font-bold"><span>Jumlah</span><span>: ${item.jml}</span></div>
                    <div class="flex justify-between pl-3 text-gray-500"><span>Onsite</span><span>: ${item["on" + ch.id] || item.onsite || 0}</span></div>
                    <div class="flex justify-between pl-3 text-gray-500"><span>Offsite</span><span>: ${item["off" + ch.id] || item.offsite || 0}</span></div>
                </div>
                <div class="space-y-4 pt-4 border-t border-blue-100/50">
                    <div>
                        <div class="flex justify-between text-[9px] font-black text-gray-400 uppercase"><span>Productivity</span></div>
                        <div class="flex justify-between items-end">
                            <span class="text-xl font-black text-gray-800">${item["prd" + ch.id] || item.prd || "0%"}</span>
                            <span class="text-red-500 text-[9px] font-bold">↓ 1.5%</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });

        // PERFORMANCE & CHARTS
        document.getElementById("perf-kpi").innerText =
          data.performance_potensi.kpi.score + "%";
        document.getElementById("perf-dpk").innerText =
          data.performance_potensi.total_dpk.market_share_total + "%";
        document.getElementById("perf-npl").innerText =
          data.performance_potensi.kredit.npl.current_value;
        initLineChart(
          "mainDpkChart",
          data.performance_potensi.total_dpk.trend_labels,
          data.performance_potensi.total_dpk.trend_values,
          "#2563eb",
        );
        initLineChart(
          "loanChart",
          data.performance_potensi.kredit.trend_labels,
          data.performance_potensi.kredit.trend_values,
          "#1e40af",
        );

        // HUMAN CAPITAL
        const hcBody = document.getElementById("hc-table-body");
        let sF = 0,
          sP = 0,
          sG = 0;
        data.human_capital.detail_formasi.forEach((r) => {
          sF += r.formasi;
          sP += r.pemenuhan;
          sG += r.gap;
          hcBody.innerHTML += `<tr class="hover:bg-blue-50/50 transition-colors"><td class="px-8 py-5 font-bold text-gray-700">${r.jabatan}</td><td class="text-center font-semibold text-gray-500">${r.formasi}</td><td class="text-center text-blue-600 font-black">${r.pemenuhan}</td><td class="text-center"><span class="${r.gap > 0 ? "text-red-600 bg-red-50 px-3 py-1 rounded-full font-black" : "text-gray-300"}">${r.gap}</span></td></tr>`;
        });
        document.getElementById("total-formasi").innerText = sF;
        document.getElementById("total-pemenuhan").innerText = sP;
        document.getElementById("total-gap").innerText = sG;

        // CUSTOMER
        document.getElementById("cust-total").innerText =
          data.customer.total_cif.total.toLocaleString("id-ID");
        const genIcons = {
          Boomers: "elderly",
          "Gen X": "person",
          Millennials: "devices",
          "Gen Z": "bolt",
        };
        const cL = [],
          cV = [];
        data.customer.demographic_generation.forEach((g) => {
          cL.push(g.label);
          cV.push(g.value);
          document.getElementById("cust-gen-container").innerHTML +=
            `<div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm flex items-center justify-between hover:shadow-md transition-shadow"><div><p class="text-gray-400 text-[10px] font-black uppercase tracking-widest">${g.label}</p><p class="text-3xl font-black text-blue-900 mt-1">${g.value.toLocaleString("id-ID")}</p></div><div class="bg-blue-50 text-blue-600 w-12 h-12 rounded-2xl flex items-center justify-center"><span class="material-icons">${genIcons[g.label] || "groups"}</span></div></div>`;
        });
        initPieChart("customerPieChart", cL, cV);

        // TAB NAVIGATION
        const tabs = document.querySelectorAll(".tab-btn");
        tabs.forEach(
          (btn) =>
            (btn.onclick = () => {
              tabs.forEach((b) => b.classList.remove("tab-active"));
              document
                .querySelectorAll(".tab-content")
                .forEach((c) => c.classList.add("hidden"));
              btn.classList.add("tab-active");
              document
                .getElementById(btn.dataset.target)
                .classList.remove("hidden");
            }),
        );
        tabs[0].click();
      });
    </script>
  </body>
</html>
